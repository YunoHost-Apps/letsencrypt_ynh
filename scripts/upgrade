#!/bin/bash

app=letsencrypt
domains=$(sudo yunohost app setting $app installDomains)

# Add 000- as prefix to nginx conf
for domain in $domains
do
    # If using old nginx conf path (without prefix), migrate it
    if [ -e  "/etc/nginx/conf.d/$domain.d/$app.conf" ]; then
      sudo mv /etc/nginx/conf.d/$domain.d/$app.conf \
              /etc/nginx/conf.d/$domain.d/000-$app.conf
    fi
done

# Move letsencrypt client to /opt/yunohost/letsencrypt
if [ -e "/root/.letsencrypt/letsencrypt-auto" ]
    mkdir -p /opt/yunohost/
    mv /root/.letsencrypt/ /opt/yunohost/letsencrypt/
    sed -i "%s|\/root\/\.letsencrypt/|/opt/yunohost/letsencrypt/|g" /etc/cron.weekly/certificateRenewer
fi

sudo service nginx reload
